<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="referrer" content="no-referrer">
    <title>Dil Matkabƒ± Pro v25 - Minimal</title>
    
    <!-- Sistem Fontlarƒ± -->
    <style>
        :root {
            /* PERFORMANS RENKLERƒ∞ */
            --bg-dark: #000000;
            --panel-bg: #111111; 
            --surface: #222222;
            --border: #444444;
            --accent: #0066FF;
            --text: #ffffff;
            --text-sec: #aaaaaa;
            --danger: #cc0000;
            
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --safe-top: env(safe-area-inset-top, 20px);
        }

        /* RESET */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-dark); 
            color: var(--text); 
            height: 100vh; overflow: hidden; 
            display: flex; flex-direction: column;
        }

        /* === TOAST === */
        #toast-container {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 9999; pointer-events: none; width: 90%; max-width: 300px;
        }
        .toast {
            background: #333; border: 1px solid #555;
            color: white; padding: 8px; text-align: center;
            font-size: 12px; margin-bottom: 5px;
            opacity: 0; transition: opacity 0.1s;
        }
        .toast.show { opacity: 1; }

        /* === INTRO (Ultra Minimal) === */
        #intro-layer {
            position: absolute; inset: 0; background: #000; z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #intro-layer.hidden { display: none; }
        
        .search-container { width: 80%; max-width: 400px; }
        
        /* √ñZEL TASARIM: √áer√ßevesiz Input */
        .search-box {
            width: 100%; 
            background: transparent; /* Arka plan yok */
            border: none; /* √áer√ßeve yok */
            border-bottom: 1px solid #333; /* Sadece ince alt √ßizgi */
            padding: 15px 5px; 
            color: white; 
            font-size: 24px; /* B√ºy√ºk, okunaklƒ± yazƒ± */
            text-align: center; /* Ortada yazsƒ±n */
            font-weight: 300;
            border-radius: 0;
            transition: border-color 0.2s;
        }
        .search-box:focus {
            border-bottom-color: var(--accent); /* Odaklanƒ±nca √ßizgi mavi olsun */
        }
        .search-box::placeholder { opacity: 0; } /* Placeholder g√∂r√ºnmesin */
        
        /* === ANA SAHNE === */
        #main-stage { position: absolute; inset: 0; z-index: 1; background: #000; }
        iframe { width: 100%; height: 100%; border: none; background: #fff; }
        .iframe-placeholder {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; 
            color: #222; font-size: 12px; z-index: -1;
        }

        /* === M BUTONU === */
        #magic-btn {
            position: fixed; bottom: calc(var(--safe-bottom) + 20px); right: 20px;
            width: 55px; height: 55px; 
            background: var(--accent); 
            color: white; border: none; font-size: 20px; font-weight: bold;
            z-index: 100; cursor: pointer;
            border-radius: 50%;
        }
        #magic-btn:active { background: #0055cc; }

        /* === PANEL === */
        #action-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--panel-bg); 
            border-top: 1px solid var(--border);
            padding: 15px 15px calc(var(--safe-bottom) + 15px) 15px;
            z-index: 95; 
            transform: translateY(100%); 
            transition: transform 0.15s ease-out;
            will-change: transform;
        }
        #action-sheet.open { transform: translateY(0); }
        .sheet-handle { width: 50px; height: 4px; background: #333; margin: 0 auto 15px auto; }

        /* Widgetlar */
        .perf-box {
            background: var(--surface); border: 1px solid var(--border);
            padding: 10px; margin-bottom: 10px; display: flex; align-items: center;
        }
        
        .player-widget { justify-content: space-between; }
        .pw-info { flex: 1; padding-right: 10px; overflow: hidden; }
        .pw-status { font-size: 10px; color: var(--accent); font-weight: bold; }
        .pw-text { font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pw-play { 
            width: 40px; height: 40px; background: var(--accent); border: none; 
            color: white; font-size: 18px; cursor: pointer; flex-shrink: 0;
        }

        .btn-block {
            width: 100%; padding: 12px; background: var(--surface); 
            border: 1px solid var(--border); color: white; 
            font-size: 14px; cursor: pointer; text-align: center;
            margin-bottom: 10px;
        }
        .btn-block:active { background: #333; }

        /* Slider */
        .slider-container { margin: 15px 0; }
        .slider-label { display: flex; justify-content: space-between; font-size: 11px; color: #888; margin-bottom: 5px; }
        input[type=range] { width: 100%; }

        .btn-row { display: flex; gap: 5px; }
        .btn-small { flex: 1; padding: 10px; background: #333; border: none; color: #ccc; font-size: 12px; cursor: pointer; }

        /* === K√úT√úPHANE === */
        .fullscreen-overlay {
            position: fixed; inset: 0; background: #000; z-index: 110;
            display: none; flex-direction: column;
        }
        .fullscreen-overlay.active { display: flex; }
        
        .overlay-header { 
            padding: 15px; padding-top: calc(var(--safe-top) + 15px);
            background: var(--panel-bg); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .overlay-content { flex: 1; overflow-y: auto; padding: 10px; -webkit-overflow-scrolling: touch; }

        .group-item { margin-bottom: 10px; border: 1px solid var(--border); background: #080808; }
        .group-header { padding: 12px; display: flex; justify-content: space-between; background: var(--surface); cursor: pointer; font-size: 14px;}
        .group-children { display: none; padding: 5px; border-top: 1px solid var(--border); }
        .group-item.expanded .group-children { display: block; }

        .subfolder-item { margin-top: 5px; border: 1px solid #333; }
        .subfolder-header { padding: 10px; background: #151515; font-size: 13px; display: flex; justify-content: space-between; cursor: pointer;}
        .subfolder-content { display: none; padding: 5px; background: #000; }
        .subfolder-item.expanded .subfolder-content { display: block; }

        .sentence-row { padding: 8px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; font-size: 12px; }
        .sent-tr { color: #fff; margin-bottom: 2px; }
        .sent-target { color: var(--accent); font-family: monospace; }
        
        /* Modallar */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            z-index: 200; display: none; align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-box {
            width: 90%; max-width: 300px; background: var(--panel-bg);
            border: 1px solid var(--border); padding: 20px;
        }
        .input-perf { width: 100%; padding: 10px; background: #000; border: 1px solid #444; color: white; margin-bottom: 10px; }
        
        .u-btn { padding: 8px 12px; background: #333; color: white; border: 1px solid #555; cursor: pointer; margin-right: 5px; font-size: 11px; }
        .u-btn-primary { background: var(--accent); border-color: var(--accent); }
        .u-btn-danger { background: #500; border-color: #700; }

    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- Gƒ∞Rƒ∞≈û (ULTRA MINIMAL - Sadece Input) -->
    <div id="intro-layer">
        <div class="search-container">
            <input type="text" class="search-box" id="url-input" 
                   placeholder="" 
                   autocomplete="off"
                   spellcheck="false"
                   onkeypress="if(event.key==='Enter') loadUrl(this.value)">
        </div>
    </div>

    <!-- ANA SAHNE -->
    <div id="main-stage">
        <div class="iframe-placeholder"></div>
        <iframe id="webview" src="" allowfullscreen></iframe>
    </div>

    <!-- M BUTONU -->
    <button id="magic-btn" onclick="toggleSheet()">M</button>

    <!-- PANEL -->
    <div id="action-sheet">
        <div class="sheet-handle"></div>
        
        <!-- Oynatƒ±cƒ± -->
        <div class="perf-box player-widget">
            <div class="pw-info">
                <div class="pw-status" id="pw-status">HAZIR</div>
                <div class="pw-text" id="pw-text">---</div>
            </div>
            <button class="pw-play" id="main-play-btn" onclick="togglePlay()">‚ñ∂</button>
        </div>

        <button class="btn-block" onclick="openLibrary()">[ K√úT√úPHANE ]</button>

        <div class="slider-container">
            <div class="slider-label"><span>HIZ</span><span id="speed-val">1.0x</span></div>
            <input type="range" min="0.5" max="2" step="0.1" value="1" oninput="updateSpeed(this.value)">
        </div>
        
        <div class="btn-row">
            <button class="btn-small" onclick="downloadData()">YEDEKLE</button>
            <button class="btn-small" onclick="document.getElementById('file-up').click()">Y√úKLE</button>
            <input type="file" id="file-up" style="display:none" onchange="uploadData(this)">
        </div>
    </div>

    <!-- K√úT√úPHANE OVERLAY -->
    <div id="library-overlay" class="fullscreen-overlay">
        <div class="overlay-header">
            <span style="font-weight:bold">K√úT√úPHANE</span>
            <button class="u-btn" onclick="closeLibrary()">KAPAT X</button>
        </div>
        <div class="overlay-content" id="library-content"></div>
        <div style="padding:10px; background:#111; border-top:1px solid #333">
            <button class="btn-block" onclick="showAddGroupModal()">+ YENƒ∞ GRUP</button>
        </div>
    </div>

    <!-- MODALLAR -->
    <div class="modal" id="modal-add-group">
        <div class="modal-box">
            <h3 style="margin-bottom:10px; text-align:center">GRUP EKLE</h3>
            <input type="text" id="inp-group-name" class="input-perf" placeholder="Ad">
            <select id="inp-group-lang" class="input-perf">
                <option value="ja-JP">Japonca</option>
                <option value="es-ES">ƒ∞spanyolca</option>
                <option value="ar-SA">Arap√ßa</option>
                <option value="ru-RU">Rus√ßa</option>
                <option value="de-DE">Almanca</option>
                <option value="en-US">ƒ∞ngilizce</option>
            </select>
            <div class="btn-row">
                <button class="btn-small" onclick="closeModals()">ƒ∞PTAL</button>
                <button class="btn-small" style="background:var(--accent); color:white" onclick="confirmAddGroup()">EKLE</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-add-sub">
        <div class="modal-box">
            <h3 style="margin-bottom:10px; text-align:center">KONU EKLE</h3>
            <div style="font-size:11px; margin-bottom:5px; text-align:center" id="lbl-parent-lang"></div>
            <input type="text" id="inp-sub-name" class="input-perf" placeholder="Ad">
            <div class="btn-row">
                <button class="btn-small" onclick="closeModals()">ƒ∞PTAL</button>
                <button class="btn-small" style="background:var(--accent); color:white" onclick="confirmAddSub()">EKLE</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-sent">
        <div class="modal-box">
            <h3 id="sent-modal-title" style="margin-bottom:10px; text-align:center">C√úMLE</h3>
            <textarea id="inp-sent-tr" class="input-perf" rows="2" placeholder="TR"></textarea>
            <textarea id="inp-sent-target" class="input-perf" rows="2" placeholder="HEDEF"></textarea>
            <div class="btn-row">
                <button class="btn-small" onclick="closeModals()">ƒ∞PTAL</button>
                <button class="btn-small" style="background:var(--accent); color:white" onclick="confirmSent()">KAYDET</button>
            </div>
        </div>
    </div>

    <script>
        // --- AYNI MANTIK (LOGIC) KORUNDU ---
        let groups = JSON.parse(localStorage.getItem('dm_v21_data')) || [];
        let activeGroupId = null, activeSubId = null, editSentIndex = null;
        let isPlaying = false, playlist = [], pIndex = 0, pLang = 'en-US', playTimeout, speed = 1.0;
        const synth = window.speechSynthesis;

        window.addEventListener('load', () => {
            document.body.addEventListener('click', () => { if(!synth.speaking) synth.resume(); }, {once:true});
            renderLibrary();
        });

        function showToast(msg) {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = 'toast'; t.innerText = msg;
            c.appendChild(t);
            // Force reflow
            void t.offsetWidth;
            t.classList.add('show');
            setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 100); }, 1500);
        }

        function loadUrl(val) {
            let url = val.trim();
            if(!url) return;
            if (!url.startsWith('http') && url.includes('.')) url = 'https://' + url;
            else if (!url.startsWith('http')) url = 'https://www.google.com/search?q=' + encodeURIComponent(val);
            
            document.getElementById('webview').src = url;
            // Display none performans i√ßin daha iyi (GPU layer'ƒ± kaldƒ±rƒ±r)
            document.getElementById('intro-layer').style.display = 'none';
        }

        function toggleSheet() { document.getElementById('action-sheet').classList.toggle('open'); }
        function openLibrary() { renderLibrary(); document.getElementById('library-overlay').classList.add('active'); }
        function closeLibrary() { document.getElementById('library-overlay').classList.remove('active'); }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }

        function renderLibrary() {
            const container = document.getElementById('library-content');
            container.innerHTML = "";
            if(groups.length === 0) { container.innerHTML = "<div style='text-align:center;color:#666;margin-top:20px'>BO≈û</div>"; return; }

            groups.forEach(group => {
                const gDiv = document.createElement('div');
                gDiv.className = 'group-item';
                gDiv.innerHTML = `
                    <div class="group-header" onclick="toggleExpand(this)">
                        <span>[${group.lang.split('-')[0].toUpperCase()}] ${group.name}</span>
                        <span>‚ñº</span>
                    </div>
                    <div class="group-children"></div>`;
                container.appendChild(gDiv);
                
                const childCont = gDiv.querySelector('.group-children');
                const addBtn = document.createElement('button');
                addBtn.className = 'u-btn'; addBtn.style.width='100%'; addBtn.style.marginBottom='5px';
                addBtn.innerText = "+ KONU EKLE"; addBtn.onclick = (e)=>{e.stopPropagation(); showAddSubModal(group.id, group.name)};
                childCont.appendChild(addBtn);

                if(group.subfolders) {
                    group.subfolders.forEach(sub => {
                        const sDiv = document.createElement('div');
                        sDiv.className = 'subfolder-item';
                        sDiv.innerHTML = `
                            <div class="subfolder-header" onclick="toggleExpand(this)">
                                <span>üìÅ ${sub.name} (${sub.sentences.length})</span>
                                <button class="u-btn u-btn-danger" style="padding:2px 6px" onclick="event.stopPropagation();deleteSub('${group.id}','${sub.id}')">X</button>
                            </div>
                            <div class="subfolder-content">
                                <div style="margin-bottom:5px; display:flex; gap:5px">
                                    <button class="u-btn u-btn-primary" style="flex:1" onclick="startPlaylist('${group.id}','${sub.id}')">OYNAT</button>
                                    <button class="u-btn" style="flex:1" onclick="showSentModal('${group.id}','${sub.id}',null)">EKLE</button>
                                </div>
                                <div>${sub.sentences.map((s,i)=>`
                                    <div class="sentence-row">
                                        <div style="flex:1; margin-right:5px">
                                            <div class="sent-tr">${s.tr}</div>
                                            <div class="sent-target">${s.target}</div>
                                        </div>
                                        <div>
                                            <button class="u-btn" onclick="showSentModal('${group.id}','${sub.id}',${i})">D</button>
                                            <button class="u-btn u-btn-danger" onclick="deleteSent('${group.id}','${sub.id}',${i})">X</button>
                                        </div>
                                    </div>`).join('')}</div>
                            </div>`;
                        childCont.appendChild(sDiv);
                    });
                }
                const delDiv = document.createElement('div'); delDiv.style.padding="5px"; delDiv.style.textAlign="center";
                delDiv.innerHTML = `<button class="u-btn u-btn-danger" style="width:100%" onclick="deleteGroup('${group.id}')">GRUBU Sƒ∞L</button>`;
                childCont.appendChild(delDiv);
            });
        }
        function toggleExpand(el) { el.parentElement.classList.toggle('expanded'); }

        function showAddGroupModal(){ document.getElementById('modal-add-group').classList.add('active'); }
        function showAddSubModal(gid, name){ activeGroupId=gid; document.getElementById('lbl-parent-lang').innerText=name; document.getElementById('modal-add-sub').classList.add('active'); }
        function showSentModal(gid, sid, idx){
            activeGroupId=gid; activeSubId=sid; editSentIndex=idx;
            const tr=document.getElementById('inp-sent-tr'), tgt=document.getElementById('inp-sent-target');
            if(idx!==null){ const s=groups.find(x=>x.id==gid).subfolders.find(x=>x.id==sid).sentences[idx]; tr.value=s.tr; tgt.value=s.target; }
            else{ tr.value=""; tgt.value=""; }
            document.getElementById('modal-sent').classList.add('active');
        }
        function confirmAddGroup(){
            const n=document.getElementById('inp-group-name').value, l=document.getElementById('inp-group-lang').value;
            if(n){ groups.push({id:Date.now().toString(), name:n, lang:l, subfolders:[]}); save(); renderLibrary(); closeModals(); }
        }
        function confirmAddSub(){
            const n=document.getElementById('inp-sub-name').value;
            if(n && activeGroupId){ groups.find(x=>x.id==activeGroupId).subfolders.push({id:Date.now().toString(), name:n, sentences:[]}); save(); renderLibrary(); closeModals(); }
        }
        function confirmSent(){
            const tr=document.getElementById('inp-sent-tr').value, tgt=document.getElementById('inp-sent-target').value;
            if(tr && tgt && activeGroupId){
                const s=groups.find(x=>x.id==activeGroupId).subfolders.find(x=>x.id==activeSubId).sentences;
                if(editSentIndex!==null) s[editSentIndex]={tr,target:tgt}; else s.push({tr,target:tgt});
                save(); renderLibrary(); closeModals();
            }
        }
        function deleteGroup(id){ if(confirm("Sil?")) { groups=groups.filter(x=>x.id!==id); save(); renderLibrary(); } }
        function deleteSub(gid, sid){ if(confirm("Sil?")) { const g=groups.find(x=>x.id==gid); g.subfolders=g.subfolders.filter(x=>x.id!==sid); save(); renderLibrary(); } }
        function deleteSent(gid, sid, idx){ if(confirm("Sil?")) { groups.find(x=>x.id==gid).subfolders.find(x=>x.id==sid).sentences.splice(idx,1); save(); renderLibrary(); } }
        function save(){ localStorage.setItem('dm_v21_data', JSON.stringify(groups)); }

        function startPlaylist(gid, sid){
            const g=groups.find(x=>x.id==gid), s=g.subfolders.find(x=>x.id==sid);
            if(!s.sentences.length) return showToast("Bo≈ü");
            playlist=s.sentences; pLang=g.lang; pIndex=0;
            closeLibrary(); document.getElementById('action-sheet').classList.remove('open');
            isPlaying=true; updatePlayIcon(); loop(); updateUI("OYNATILIYOR", s.name);
        }
        function togglePlay(){
            if(isPlaying){ isPlaying=false; synth.cancel(); clearTimeout(playTimeout); updateUI("DURAKLATILDI","..."); }
            else{ if(!playlist.length){showToast("Se√ßim Yok"); openLibrary(); return;} isPlaying=true; loop(); }
            updatePlayIcon();
        }
        function loop(){
            if(!isPlaying) return;
            if(pIndex>=playlist.length) pIndex=0;
            const item=playlist[pIndex];
            updateUI("T√úRK√áE", item.tr);
            speak(item.tr, 'tr-TR', ()=>{
                if(!isPlaying) return;
                updateUI("...", item.tr);
                playTimeout=setTimeout(()=>{
                    if(!isPlaying) return;
                    updateUI("CEVAP", item.target);
                    speak(item.target, pLang, ()=>{
                        if(!isPlaying) return;
                        playTimeout=setTimeout(()=>{ pIndex++; loop(); }, 1500);
                    });
                }, 2000);
            });
        }
        function speak(txt, lang, cb){
            synth.cancel(); const u=new SpeechSynthesisUtterance(txt); u.lang=lang; u.rate=parseFloat(speed);
            const vs=synth.getVoices(); let v=vs.find(x=>x.lang==lang&&(x.name.includes('Google')||x.name.includes('Enhanced')));
            if(!v) v=vs.find(x=>x.lang==lang); if(v) u.voice=v;
            u.onend=cb; u.onerror=cb; synth.speak(u);
        }
        function updateUI(s, t){ document.getElementById('pw-status').innerText=s; document.getElementById('pw-text').innerText=t; }
        function updatePlayIcon(){ document.getElementById('main-play-btn').innerText=isPlaying?"‚è∏":"‚ñ∂"; }
        function updateSpeed(v){ speed=v; document.getElementById('speed-val').innerText=v+"x"; }

        function downloadData(){
            const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(groups));
            a.download="dm_yedek.json"; a.click();
        }
        function uploadData(inp){
            const f=inp.files[0]; if(!f)return;
            const r=new FileReader(); r.onload=e=>{ try{groups=JSON.parse(e.target.result); save(); showToast("Tamam"); renderLibrary();}catch(x){showToast("Hata");} };
            r.readAsText(f);
        }
    </script>
</body>
</html>
